# Add a new line with time stamp to the file.txt when dispatched

name: Push

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  get-image-list:
    runs-on: ubuntu-latest
    name: List images to be released
    outputs:
      image-paths: ${{ steps.images.outputs.paths }}
    steps:
      - uses: actions/checkout@v4
      - uses: tj-actions/changed-files@v44
        id: changed-files
        with:
          files: |
            oci/*/*
          dir_names: 'true'
          dir_names_max_depth: '3'
          separator: ','
      - name: List all changed images
        id: images
        run: |
          if [[ "${{ steps.changed-files.outputs.all_changed_files_count }}" == "0" ]]
          then
            # Fixed image for testing
            paths="oci/mock-default"
          else
            paths='${{ steps.changed-files.outputs.all_changed_files }}'
            occurrences="${paths//[^,]}"
            if [ ${#occurrences} -ne 0 ]
            then
              echo "ERR: can only build 1 image at a time, but trying to trigger ${paths}"
              exit 1
            fi
            test -d "${paths}"
          fi
          echo "Changed paths: $paths"
          echo "paths=$paths" >> $GITHUB_OUTPUT



  access-guard:
    uses: zhijie-yang/workflow-playground/.github/actions/validate-access.yaml@master
    needs: [get-image-list]
    secrets: inherit
    with:
      admin-only: true
      image-path: ${{ needs.get-image-list.outputs.image-paths }}


  commit-and-push:
    runs-on: ubuntu-latest
    needs: [access-guard]
    outputs:
      commit-sha: ${{ steps.commit.outputs.commit-sha }}
    
    steps:
      - uses: actions/checkout@v4
    

      - run: |
          echo $(date)
    
      # - name: Add time stamp
      #   run: |
      #       echo $(date) >> file.txt

      # - name: Commit file.txt
      #   uses: actions-x/commit@v6
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     branch: ${{ github.ref }}
      #     message: 'ci: automatically update file.txt, from ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
      #     files: file.txt

      - name: Get commit SHA
        id: commit
        run: |
          set -ex
          echo "commit-sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      

  call-workflow:
    name: Call on new commit
    needs: [commit-and-push]
    uses: ./.github/workflows/call-on-new-commit.yaml
    with:
      commit-sha: ${{ needs.commit-and-push.outputs.commit-sha }}
    secrets: inherit
